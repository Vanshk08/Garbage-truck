<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinByte | Smart Waste Solutions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f2f5; }
        .header { background: #2c3e50; color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #map { height: 450px; width: 95%; margin: 20px auto; border-radius: 10px; border: 2px solid #ddd; }
        .container { width: 95%; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 50px; }
        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #2980b9; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        #stats { font-weight: bold; color: #2ecc71; margin-top: 5px; }
        .truck-icon {
            width: 40px;
            height: 40px;
            position: relative;
        }
        .truck-svg {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<header style="background: #2d3436; color: white; padding: 15px; text-align: center; font-family: sans-serif; border-bottom: 4px solid #2ecc71;">
    <h1 style="margin: 0; letter-spacing: 2px;">
        <span style="color: #2ecc71;">Bin</span>Byte
    </h1>
    <p style="margin: 5px 0 0; font-size: 0.9rem; color: #dfe6e9;">Smart City Waste Ecosystem</p>
</header>
<body>

    <div class="header">
        <h1>WasteTrack: Municipal Garbage Monitoring</h1>
        <div id="stats">Connecting to system...</div>
    </div>

    <div id="map"></div>

    <div class="container">
        <div class="card">
            <h3>Citizen Complaint Portal</h3>
            <p style="font-size: 0.9rem; color: #666;">Click a red circle on the map to get the Area ID.</p>
            <input type="text" id="areaId" placeholder="Area ID (e.g., 65af...)">
            <input type="text" id="reason" placeholder="Issue (e.g., Garbage not picked up)">
            <button onclick="fileComplaint()">Submit Complaint</button>
            <p id="complaintMsg" style="margin-top:10px; font-weight:bold;"></p>
        </div>

        <div class="card">
            <h3>Municipal Admin View</h3>
            <button onclick="viewComplaints()" style="background: #27ae60;">Refresh Complaints</button>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Area ID</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="complaintTableBody">
                        <tr><td colspan="4" style="text-align:center;">Click refresh to load data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>Truck Tracking</h3>
            <button onclick="updateTruckTracking()" style="background: #3498db; margin-bottom: 10px;">Refresh Tracking</button>
            <div style="overflow-x:auto; margin-top: 15px;">
                <table style="width: 100%;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">Truck ID</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">Next Area</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">ETA</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="truckTrackingBody">
                        <tr><td colspan="4" style="text-align:center; padding: 20px; color: #7f8c8d;">Loading tracking data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Use relative path for Vercel, localhost for local dev
        const API_BASE = window.location.hostname === "localhost" ? "http://localhost:5000/api" : "/api";

        const map = L.map('map').setView([28.6139, 77.2090], 13); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Create custom truck icon with SVG
        function createTruckIcon(truckId, rotation = 0) {
            return L.divIcon({
                className: 'truck-icon-wrapper',
                html: `
                    <svg class="truck-svg" width="45" height="45" viewBox="0 0 45 45" style="transform: rotate(${rotation}deg);">
                        <!-- Truck body/container -->
                        <rect x="10" y="16" width="22" height="14" fill="#e67e22" stroke="#fff" stroke-width="2.5" rx="2"/>
                        <!-- Truck cab -->
                        <rect x="6" y="19" width="9" height="11" fill="#d35400" stroke="#fff" stroke-width="2.5" rx="1.5"/>
                        <!-- Truck windshield -->
                        <rect x="7" y="20" width="7" height="6" fill="#3498db" stroke="#fff" stroke-width="1"/>
                        <!-- Back wheels -->
                        <circle cx="15" cy="32" r="3.5" fill="#2c3e50" stroke="#fff" stroke-width="2"/>
                        <circle cx="15" cy="32" r="2" fill="#34495e"/>
                        <!-- Front wheels -->
                        <circle cx="30" cy="32" r="3.5" fill="#2c3e50" stroke="#fff" stroke-width="2"/>
                        <circle cx="30" cy="32" r="2" fill="#34495e"/>
                        <!-- Container detail lines -->
                        <line x1="16" y1="17" x2="16" y2="30" stroke="#fff" stroke-width="1.5"/>
                        <line x1="22" y1="17" x2="22" y2="30" stroke="#fff" stroke-width="1.5"/>
                        <!-- Container top -->
                        <rect x="10" y="16" width="22" height="3" fill="#c0392b" rx="2"/>
                    </svg>
                `,
                iconSize: [45, 45],
                iconAnchor: [22.5, 22.5]
            });
        }

        // Truck positions and routes on actual roads (coordinates aligned with visible roads on the map)
        const trucks = [
            { 
                id: 'Truck-001', 
                position: [28.6140, 77.2092], 
                rotation: 35,
                route: [
                    [28.6140, 77.2092],
                    [28.6142, 77.2094],
                    [28.6145, 77.2097],
                    [28.6148, 77.2100],
                    [28.6150, 77.2102],
                    [28.6152, 77.2104],
                    [28.6154, 77.2106],
                    [28.6156, 77.2108],
                    [28.6158, 77.2110],
                    [28.6160, 77.2112],
                    [28.6158, 77.2110],
                    [28.6156, 77.2108],
                    [28.6154, 77.2106],
                    [28.6152, 77.2104],
                    [28.6150, 77.2102],
                    [28.6148, 77.2100],
                    [28.6145, 77.2097],
                    [28.6142, 77.2094],
                    [28.6140, 77.2092]
                ],
                color: '#3498db'
            },
            { 
                id: 'Truck-002', 
                position: [28.6123, 77.2083], 
                rotation: -25,
                route: [
                    [28.6123, 77.2083],
                    [28.6125, 77.2085],
                    [28.6127, 77.2087],
                    [28.6129, 77.2089],
                    [28.6131, 77.2091],
                    [28.6133, 77.2093],
                    [28.6135, 77.2095],
                    [28.6137, 77.2097],
                    [28.6139, 77.2099],
                    [28.6141, 77.2101],
                    [28.6139, 77.2099],
                    [28.6137, 77.2097],
                    [28.6135, 77.2095],
                    [28.6133, 77.2093],
                    [28.6131, 77.2091],
                    [28.6129, 77.2089],
                    [28.6127, 77.2087],
                    [28.6125, 77.2085],
                    [28.6123, 77.2083]
                ],
                color: '#2ecc71'
            },
            { 
                id: 'Truck-003', 
                position: [28.6152, 77.2102], 
                rotation: 145,
                route: [
                    [28.6152, 77.2102],
                    [28.6150, 77.2100],
                    [28.6148, 77.2098],
                    [28.6146, 77.2096],
                    [28.6144, 77.2094],
                    [28.6142, 77.2092],
                    [28.6140, 77.2090],
                    [28.6138, 77.2088],
                    [28.6136, 77.2086],
                    [28.6134, 77.2084],
                    [28.6136, 77.2086],
                    [28.6138, 77.2088],
                    [28.6140, 77.2090],
                    [28.6142, 77.2092],
                    [28.6144, 77.2094],
                    [28.6146, 77.2096],
                    [28.6148, 77.2098],
                    [28.6150, 77.2100],
                    [28.6152, 77.2102]
                ],
                color: '#9b59b6'
            }
        ];

        // Function to add trucks and routes to map
        function addTrucksToMap() {
            trucks.forEach(truck => {
                // Draw route polyline following roads
                const routePolyline = L.polyline(truck.route, {
                    color: truck.color,
                    weight: 3,
                    opacity: 0.6,
                    smoothFactor: 1.0,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(map);

                // Add truck marker at current position
                const truckMarker = L.marker(truck.position, {
                    icon: createTruckIcon(truck.id, truck.rotation)
                }).addTo(map);
            });
        }

        // Add trucks to map after areas are loaded
        setTimeout(addTrucksToMap, 500);

        let areasData = [];

        async function loadAreas() {
            try {
                const response = await fetch(`${API_BASE}/areas-status`);
                const areas = await response.json();
                areasData = areas; // Store for truck tracking
                document.getElementById('stats').innerText = `System Active: Tracking ${areas.length} Areas`;

                areas.forEach(area => {
                    const color = area.isCollected ? '#2ecc71' : '#e74c3c';
                    const marker = L.circle([area.location.lat, area.location.lng], {
                        color: color, fillColor: color, fillOpacity: 0.5, radius: 400 
                    }).addTo(map);

                    marker.bindPopup(`
                        <div style="text-align:center;">
                            <b style="font-size:1.1rem;">${area.name}</b><br>
                            <code style="background:#eee; padding:2px 4px; display:block; margin:5px 0;">ID: ${area._id}</code>
                            <button onclick="copyId('${area._id}')" style="font-size:10px; padding:2px 5px; margin-bottom:10px;">Copy ID to Form</button><br>
                            Status: <b>${area.isCollected ? 'Collected' : 'Pending'}</b><br><br>
                            ${!area.isCollected ? `<button onclick="markCollected('${area._id}')" style="background:#27ae60; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer;">Mark Collected</button>` : `<span style="color:#27ae60;">Cleaned!</span>`}
                        </div>
                    `);
                });
                
                // Update truck tracking after areas are loaded
                updateTruckTracking();
            } catch (err) {
                document.getElementById('stats').innerText = "Offline: Backend not connected";
            }
        }

        // Calculate distance between two coordinates (in km)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Find nearest area to a coordinate
        function findNearestArea(lat, lng) {
            if (areasData.length === 0) return null;
            
            let nearest = areasData[0];
            let minDistance = calculateDistance(lat, lng, nearest.location.lat, nearest.location.lng);
            
            areasData.forEach(area => {
                const distance = calculateDistance(lat, lng, area.location.lat, area.location.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = area;
                }
            });
            
            return { area: nearest, distance: minDistance };
        }

        // Get next route point for a truck
        function getNextRoutePoint(truck) {
            const currentPos = truck.position;
            let minDist = Infinity;
            let nextPoint = truck.route[0];
            let nextIndex = 0;
            
            // Find current position in route
            truck.route.forEach((point, index) => {
                const dist = calculateDistance(currentPos[0], currentPos[1], point[0], point[1]);
                if (dist < minDist) {
                    minDist = dist;
                    nextIndex = (index + 1) % truck.route.length;
                    nextPoint = truck.route[nextIndex];
                }
            });
            
            return nextPoint;
        }

        // Area names for display
        const areaNames = [
            'College Main Gate', 'Library Lane', 'Hostel Block A',
            'Sports Complex', 'Cafeteria Area', 'Parking Lot B',
            'Admin Building', 'Student Center', 'Residential Block C',
            'Gymnasium', 'Auditorium', 'Medical Center'
        ];

        // Get random area name
        function getRandomArea() {
            if (areasData.length > 0) {
                // Use actual area names if available
                const randomArea = areasData[Math.floor(Math.random() * areasData.length)];
                return randomArea.name;
            }
            // Fallback to predefined names
            return areaNames[Math.floor(Math.random() * areaNames.length)];
        }

        // Get random time (5-45 minutes from now)
        function getRandomTime() {
            const now = new Date();
            const randomMinutes = Math.floor(Math.random() * 40) + 5; // 5-45 minutes
            const arrivalTime = new Date(now.getTime() + randomMinutes * 60000);
            
            const timeStr = arrivalTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            
            return { timeStr, minutes: randomMinutes };
        }

        // Update truck tracking table
        function updateTruckTracking() {
            const tableBody = document.getElementById('truckTrackingBody');
            tableBody.innerHTML = '';
            
            // Store truck tracking data to maintain consistency
            if (!window.truckTrackingData) {
                window.truckTrackingData = {};
                trucks.forEach(truck => {
                    window.truckTrackingData[truck.id] = {
                        area: getRandomArea(),
                        timeData: getRandomTime()
                    };
                });
            }
            
            trucks.forEach(truck => {
                // Occasionally update the data (10% chance on each refresh)
                if (Math.random() < 0.1) {
                    window.truckTrackingData[truck.id] = {
                        area: getRandomArea(),
                        timeData: getRandomTime()
                    };
                }
                
                const tracking = window.truckTrackingData[truck.id];
                const { timeStr, minutes } = tracking.timeData;
                
                // Determine status based on time
                let statusColor, statusText;
                if (minutes < 10) {
                    statusColor = '#2ecc71';
                    statusText = 'Arriving Soon';
                } else if (minutes < 25) {
                    statusColor = '#f39c12';
                    statusText = 'On Route';
                } else {
                    statusColor = '#3498db';
                    statusText = 'En Route';
                }
                
                tableBody.innerHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="font-weight:bold; color:${truck.color}; padding: 12px;">${truck.id}</td>
                        <td style="padding: 12px;">${tracking.area}</td>
                        <td style="padding: 12px; font-weight:500;">${timeStr}<br><span style="font-size:0.85rem; color:#7f8c8d;">(${minutes} min)</span></td>
                        <td style="padding: 12px;"><span style="color:${statusColor}; font-weight:bold; padding: 4px 8px; background:${statusColor}20; border-radius: 4px;">${statusText}</span></td>
                    </tr>
                `;
            });
        }

        function copyId(id) { document.getElementById('areaId').value = id; }

        async function markCollected(id) {
            try {
                await fetch(`${API_BASE}/collect/${id}`, { method: 'PATCH' });
                alert("Area marked as collected!");
                location.reload(); 
            } catch (err) { alert("Error updating status"); }
        }

        async function fileComplaint() {
            const areaId = document.getElementById('areaId').value;
            const description = document.getElementById('reason').value;
            if (!areaId || !description) { alert("Please fill all fields!"); return; }

            try {
                const response = await fetch(`${API_BASE}/complaint`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ areaId, description })
                });
                document.getElementById('complaintMsg').innerText = "Complaint Sent Successfully!";
                document.getElementById('areaId').value = "";
                document.getElementById('reason').value = "";
            } catch (err) { alert("Failed to send complaint"); }
        }

        async function viewComplaints() {
            try {
                const response = await fetch(`${API_BASE}/view-complaints`);
                const complaints = await response.json();
                const tableBody = document.getElementById('complaintTableBody');
                tableBody.innerHTML = ""; 

                if(complaints.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='4'>No complaints found.</td></tr>";
                    return;
                }

                complaints.forEach(c => {
                    tableBody.innerHTML += `
                        <tr>
                            <td style="font-size:11px;">${c.areaId}</td>
                            <td>${c.description}</td>
                            <td><span class="status-badge" style="background:#ffeaa7; color:#d63031;">${c.status}</span></td>
                            <td><button onclick="withdrawComplaint('${c._id}')" style="background:#e67e22; padding:5px 10px; font-size:12px;">Withdraw</button></td>
                        </tr>
                    `;
                });
            } catch (err) { console.error(err); }
        }

        async function withdrawComplaint(complaintId) {
            if(!confirm("Resolve this complaint?")) return;
            try {
                const response = await fetch(`${API_BASE}/withdraw-complaint/${complaintId}`, { method: 'DELETE' });
                const data = await response.json();
                alert(data.message);
                viewComplaints();
            } catch (err) { alert("Error withdrawing complaint"); }
        }

        loadAreas();
        
        // Auto-refresh truck tracking every 30 seconds
        setInterval(updateTruckTracking, 30000);
    </script>
</body>
<footer style="text-align: center; padding: 20px; font-size: 0.8rem; color: #636e72;">
    © 2026 Developed by Team BinByte for the Hackathon
</footer>
</html>