<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinByte | Smart Waste Solutions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f2f5; }
        .header { background: #2c3e50; color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #map { height: 450px; width: 95%; margin: 20px auto; border-radius: 10px; border: 2px solid #ddd; }
        .container { width: 95%; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 50px; }
        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #2980b9; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: #f8f9fa; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 12px; }
        #stats { font-weight: bold; color: #2ecc71; margin-top: 5px; }
        .truck-icon {
            width: 40px;
            height: 40px;
            position: relative;
        }
        .truck-svg {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<header style="background: #2d3436; color: white; padding: 15px; text-align: center; font-family: sans-serif; border-bottom: 4px solid #2ecc71;">
    <h1 style="margin: 0; letter-spacing: 2px;">
        <span style="color: #2ecc71;">Bin</span>Byte
    </h1>
    <p style="margin: 5px 0 0; font-size: 0.9rem; color: #dfe6e9;">Smart City Waste Ecosystem</p>
</header>
<body>

    <div class="header">
        <h1>WasteTrack: Municipal Garbage Monitoring</h1>
        <div id="stats">Connecting to system...</div>
    </div>

    <div id="map"></div>

    <div class="container">
        <div class="card">
            <h3>Citizen Complaint Portal</h3>
            <p style="font-size: 0.9rem; color: #666;">Click a red circle on the map to get the Area ID.</p>
            <input type="text" id="areaId" placeholder="Area ID (e.g., 65af...)">
            <input type="text" id="reason" placeholder="Issue (e.g., Garbage not picked up)">
            <button onclick="fileComplaint()">Submit Complaint</button>
            <p id="complaintMsg" style="margin-top:10px; font-weight:bold;"></p>
        </div>

        <div class="card">
            <h3>Municipal Admin View</h3>
            <button onclick="viewComplaints()" style="background: #27ae60;">Refresh Complaints</button>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Area ID</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="complaintTableBody">
                        <tr><td colspan="4" style="text-align:center;">Click refresh to load data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>Truck Tracking</h3>
            <button onclick="updateTruckTracking()" style="background: #3498db; margin-bottom: 10px;">Refresh Tracking</button>
            <div style="overflow-x:auto; margin-top: 15px;">
                <table style="width: 100%;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">Truck ID</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">Next Area</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">ETA</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #3498db;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="truckTrackingBody">
                        <tr><td colspan="4" style="text-align:center; padding: 20px; color: #7f8c8d;">Loading tracking data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
 // 1. Configuration & Global Variables
const API_BASE = window.location.hostname === "localhost" ? "http://localhost:5000/api" : "/api";
const map = L.map('map').setView([28.6139, 77.2090], 13);
let currentMarkers = []; // This tracks our circles to prevent stacking
let areasData = [];      // This tracks our database info

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// 2. The MASTER loadAreas Function (Fixed Logic)
async function loadAreas() {
    try {
        const response = await fetch(`${API_BASE}/areas-status`);
        const areas = await response.json();
        areasData = areas; 
        
        // Update stats
        document.getElementById('stats').innerText = `System Active: Tracking ${areas.length} Areas`;

        // IMPORTANT: Clear old circles before drawing new ones
        currentMarkers.forEach(m => map.removeLayer(m));
        currentMarkers = [];

        areas.forEach(area => {
            // Check BOTH status and boolean to be 100% sure
            const isPending = area.status === 'pending' || area.isCollected === false;
            const color = isPending ? '#e74c3c' : '#2ecc71';

            const marker = L.circle([area.location.lat, area.location.lng], {
                color: color, 
                fillColor: color, 
                fillOpacity: 0.5, 
                radius: 400 
            }).addTo(map);

            currentMarkers.push(marker);

            marker.bindPopup(`
                <div style="text-align:center;">
                    <b style="font-size:1.1rem;">${area.name}</b><br>
                    <code style="background:#eee; padding:2px 4px; display:block; margin:5px 0;">ID: ${area._id}</code>
                    <button onclick="copyId('${area._id}')" style="font-size:10px; padding:2px 5px; margin-bottom:10px;">Copy ID to Form</button><br>
                    Status: <b>${isPending ? 'Pending' : 'Collected'}</b><br><br>
                    ${isPending ? 
                        `<button onclick="markCollected('${area._id}')" style="background:#27ae60; color:white; border:none; padding:8px; border-radius:3px; cursor:pointer; font-weight:bold;">ðŸš› Mark Collected</button>` 
                        : `<span style="color:#27ae60; font-weight:bold;">âœ… Cleaned!</span>`
                    }
                </div>
            `);
        });
        
        updateTruckTracking();
    } catch (err) {
        console.error("Load Error:", err);
        document.getElementById('stats').innerText = "Offline: Backend not connected";
    }
}

// 3. Mark Collected Function
async function markCollected(id) {
    try {
        const response = await fetch(`${API_BASE}/collect/${id}`, { 
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'collected' })
        });
        
        if (response.ok) {
            // Re-run the map update without refreshing the whole page
            await loadAreas(); 
            alert("Area updated successfully!");
        }
    } catch (err) { alert("Error updating status"); }
}

// 4. Complaint Management
async function fileComplaint() {
    const areaId = document.getElementById('areaId').value;
    const description = document.getElementById('reason').value;
    if (!areaId || !description) { alert("Please fill all fields!"); return; }

    try {
        await fetch(`${API_BASE}/complaint`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ areaId, description })
        });
        document.getElementById('complaintMsg').innerText = "Complaint Sent Successfully!";
        document.getElementById('areaId').value = "";
        document.getElementById('reason').value = "";
    } catch (err) { alert("Failed to send complaint"); }
}

async function viewComplaints() {
    try {
        const response = await fetch(`${API_BASE}/view-complaints`);
        const complaints = await response.json();
        const tableBody = document.getElementById('complaintTableBody');
        tableBody.innerHTML = complaints.length === 0 ? "<tr><td colspan='4'>No complaints found.</td></tr>" : ""; 

        complaints.forEach(c => {
            tableBody.innerHTML += `
                <tr>
                    <td style="font-size:11px;">${c.areaId}</td>
                    <td>${c.description}</td>
                    <td><span class="status-badge" style="background:#ffeaa7; color:#d63031;">${c.status}</span></td>
                    <td><button onclick="withdrawComplaint('${c._id}')" style="background:#e67e22; padding:5px 10px; font-size:12px;">Withdraw</button></td>
                </tr>`;
        });
    } catch (err) { console.error(err); }
}

async function withdrawComplaint(complaintId) {
    if(!confirm("Resolve this complaint?")) return;
    try {
        const response = await fetch(`${API_BASE}/withdraw-complaint/${complaintId}`, { method: 'DELETE' });
        const data = await response.json();
        alert(data.message);
        viewComplaints();
    } catch (err) { alert("Error withdrawing complaint"); }
}

// 5. Truck Logic (Simplified for integration)
function createTruckIcon(truckId, rotation = 0) {
    return L.divIcon({
        className: 'truck-icon-wrapper',
        html: `<svg class="truck-svg" width="45" height="45" viewBox="0 0 45 45" style="transform: rotate(${rotation}deg);">
                <rect x="10" y="16" width="22" height="14" fill="#e67e22" stroke="#fff" rx="2"/>
                <rect x="6" y="19" width="9" height="11" fill="#d35400" stroke="#fff" rx="1.5"/>
                <circle cx="15" cy="32" r="3.5" fill="#2c3e50" stroke="#fff"/>
                <circle cx="30" cy="32" r="3.5" fill="#2c3e50" stroke="#fff"/>
               </svg>`,
        iconSize: [45, 45],
        iconAnchor: [22.5, 22.5]
    });
}

const trucks = [
    { id: 'Truck-001', position: [28.6140, 77.2092], rotation: 35, color: '#3498db', route: [[28.6140, 77.2092], [28.6160, 77.2112]] },
    { id: 'Truck-002', position: [28.6123, 77.2083], rotation: -25, color: '#2ecc71', route: [[28.6123, 77.2083], [28.6141, 77.2101]] }
];

function addTrucksToMap() {
    trucks.forEach(truck => {
        L.polyline(truck.route, { color: truck.color, weight: 3, opacity: 0.6 }).addTo(map);
        L.marker(truck.position, { icon: createTruckIcon(truck.id, truck.rotation) }).addTo(map);
    });
}

function updateTruckTracking() {
    const tableBody = document.getElementById('truckTrackingBody');
    tableBody.innerHTML = '';
    trucks.forEach(truck => {
        tableBody.innerHTML += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="font-weight:bold; color:${truck.color}; padding: 12px;">${truck.id}</td>
                <td style="padding: 12px;">Monitoring Route</td>
                <td style="padding: 12px;">Live</td>
                <td style="padding: 12px;"><span style="color:#2ecc71; font-weight:bold;">Active</span></td>
            </tr>`;
    });
}

function copyId(id) { document.getElementById('areaId').value = id; }

// Initialize
loadAreas();
setTimeout(addTrucksToMap, 500);
setInterval(loadAreas, 60000); // Auto-refresh every minute
    </script>
</body>
<footer style="text-align: center; padding: 20px; font-size: 0.8rem; color: #636e72;">
    Â© 2026 Developed by Team BinByte for the Hackathon
</footer>
</html>